<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>記録詳細（v7）</title>
<style>
  body{font-family:-apple-system,BlinkMacSystemFont,"Noto Sans JP",sans-serif;margin:16px;line-height:1.6}
  .block{border:1px solid #ddd;border-radius:10px;padding:16px;margin:16px 0;background:#fff}
  .tag{display:inline-block;padding:4px 8px;border-radius:999px;background:#f4f4f4;margin:2px 6px 2px 0;font-size:13px}
  table{border-collapse:collapse;width:100%}
  th,td{border:1px solid #eee;padding:8px;vertical-align:top}
  img{max-width:220px;height:auto;margin:6px;border:1px solid #ddd;border-radius:6px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;font-size:13px;white-space:pre-wrap}
  .chips span{display:inline-block;background:#f5f5f5;border-radius:999px;padding:4px 10px;margin:2px}
</style>
</head>
<body>
<h1>記録詳細（v7）</h1>

<div class="block">
  <h3>患者情報</h3>
  <div>氏名: {{ data.patient.name }}　/　年齢: {{ data.patient.age }}　/　性別: {{ data.patient.sex }}　/　地域: {{ data.patient.region }}</div>
  <div>主訴: {{ data.patient.chief_complaint or "（未記入）" }}</div>
  <div>レコードID: <code>{{ data.id }}</code>　/　受理: {{ data.submitted_at }}</div>
</div>

{% set pre = data.ai_assessment %}
{% set axes = pre.pattern["八綱"] %}
{% set qxs = pre.pattern["気血水"] %}
{% set vis = pre.pattern["視診補助"] %}

<div class="block">
  <h3>AI提案（最終判断は薬剤師）</h3>
  <h2>推奨方剤：<strong>{{ pre.chosen }}</strong></h2>
  <div class="mono">選定理由：{{ (pre.reasons or [])|join(" / ") }}</div>
  <div class="mono">{{ pre.chief_note }}</div>
</div>

<div class="block">
  <h3>体質の説明（お客様向け）</h3>
  <p>{{ pre.constitution }}</p>
</div>

<div class="block">
  <h3>主訴別アドバイス</h3>
  {% if pre.chief_keywords %}
    {% for a in pre.chief_advice %}
      <h4>・{{ a.title }}</h4>
      <p><strong>背景：</strong>{{ a.why }}</p>
      <p><strong>まず試す：</strong></p>
      <ul>{% for t in a.try %}<li>{{ t }}</li>{% endfor %}</ul>
      {% if a.kanpo_hint %}<p class="mono">漢方のヒント：{{ a.kanpo_hint }}</p>{% endif %}
      {% if a.redflags %}<p><strong>危険サイン：</strong></p><ul>{% for r in a.redflags %}<li>{{ r }}</li>{% endfor %}</ul>{% endif %}
    {% endfor %}
  {% else %}
    <div>（主訴に特化したアドバイスはありません）</div>
  {% endif %}
</div>

<div class="block">
  <h3>薬膳食材（体質に合わせた提案）</h3>
  {% if pre.diet %}
    <div class="chips">{% for f in pre.diet %}<span>{{ f }}</span>{% endfor %}</div>
  {% else %}
    <div>（特記なし）</div>
  {% endif %}
</div>

<div class="block">
  <h3>日常生活アドバイス</h3>
  {% if pre.lifestyle %}
    <ul>{% for a in pre.lifestyle %}<li>{{ a }}</li>{% endfor %}</ul>
  {% else %}
    <div>（特記なし）</div>
  {% endif %}
</div>

<div class="block">
  <h3>会話のきっかけ（話題ネタ）</h3>
  {% if pre.topics %}
    <ul>{% for t in pre.topics %}<li>{{ t }}</li>{% endfor %}</ul>
  {% else %}
    <div>（特記なし）</div>
  {% endif %}
</div>

<div class="block">
  <h3>説明スクリプト（読み上げ用）</h3>
  <ul>
    <li><strong>方剤の説明：</strong> {{ pre.script.explain or "—" }}</li>
    <li><strong>生活アドバイス：</strong> {{ pre.script.lifestyle or "—" }}</li>
    <li><strong>注意/フォロー：</strong> {{ pre.script.watch or "—" }}</li>
  </ul>
</div>

<div class="block">
  <h3>判定された証（パターン）</h3>
  <table>
    <tr>
      <th style="width:150px">八綱</th>
      <td>
        <span class="tag">実虚: {{ axes["実虚"] or "—" }}</span>
        <span class="tag">寒熱: {{ axes["寒熱"] or "—" }}</span>
        <span class="tag">表裏: {{ axes["表裏"] or "—" }}</span>
      </td>
    </tr>
    <tr>
      <th>気血水</th>
      <td>
        <span class="tag">気: {{ qxs["気"] or "—" }}</span>
        <span class="tag">血: {{ qxs["血"] or "—" }}</span>
        <span class="tag">水: {{ qxs["水"] or "—" }}</span>
      </td>
    </tr>
    <tr>
      <th>視診補助</th>
      <td>
        <div class="tag">脈の力: {{ vis["脈"]["力"] or "—" }}</div>
        <div class="tag">脈の速さ: {{ vis["脈"]["速さ"] or "—" }}</div>
        <div class="tag">脈の性状: {{ vis["脈"]["性状"] or "—" }}</div>
        <div class="tag">顔色: {{ vis["顔色"] or "—" }}</div>
        <div class="tag">舌の色: {{ vis["舌"]["色"] or "—" }}</div>
        <div class="tag">舌の体: {{ vis["舌"]["体"] or "—" }}</div>
        <div class="tag">舌苔: {{ vis["舌"]["苔"] or "—" }}</div>
        <div class="tag">舌の湿: {{ vis["舌"]["湿"] or "—" }}</div>
      </td>
    </tr>
  </table>
</div>

<div class="block">
  <h3>画像</h3>
  {% for part in ["tongue","face","body","nails"] %}
    <h4>{{ {"tongue":"舌","face":"顔","body":"体・むくみ","nails":"爪"}[part] }}</h4>
    {% if data.inspection_uploads[part] %}
      {% for url in data.inspection_uploads[part] %}
        <a href="{{ url }}" target="_blank"><img src="{{ url }}" alt="{{ part }}"></a>
      {% endfor %}
    {% else %}
      <div>（画像なし）</div>
    {% endif %}
  {% endfor %}
</div>

<p><a href="/admin">一覧へ</a> ｜ <a href="/">新規登録へ</a></p>
</body>
</html>
