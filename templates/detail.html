<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>解析結果</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <header>
    <h1>解析結果</h1>
  </header>

  <main>
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <ul class="flash">
          {% for cat, msg in messages %}
            <li class="{{cat}}">{{ msg }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    {% if raw_output %}
      <section>
        <h2>AI生出力（JSON解析不可）</h2>
        <pre>{{ raw_output }}</pre>
      </section>
    {% endif %}

    {% if result %}
      <section>
        <h2>基本判定</h2>
        <ul>
          <li><strong>主症状：</strong>{{ result.main_symptom }}</li>
          <li><strong>急性/慢性：</strong>{{ result.acute_or_chronic }}</li>
          <li><strong>気血水：</strong>{{ (result.kiketsusui or []) | join("・") }}</li>
          <li><strong>八綱分類：</strong>{{ result.hakkou.label }}（表裏：{{ result.hakkou.hyou_ura }} ／ 寒熱：{{ result.hakkou.kan_netsu }} ／ 虚実：{{ result.hakkou.kyo_jitsu }}）</li>
        </ul>
      </section>

      <section>
  <h2>漢方薬候補（3件）</h2>
  <ol>
    {% for k in result.kampo_candidates %}
    <li>
      <div>
        <strong>{{ k.name }}</strong>
        {% if k.priority_basis %}
          <span class="badge">{{ k.priority_basis }}</span>
        {% else %}
          <span class="badge badge-muted">優先区分なし</span>
        {% endif %}
      </div>
      <div class="small">
        {% if k.scores is defined and k.scores %}
          総合点: {{ "%.2f"|format(k.scores.total) if "total" in k.scores else "—" }}
          ／ 症状適合: {{ "%.2f"|format(k.scores.symptom_fit) if "symptom_fit" in k.scores else "—" }}
          ／ 証適合: {{ "%.2f"|format(k.scores.constitution_fit) if "constitution_fit" in k.scores else "—" }}
          ／ 安全性: {{ "%.2f"|format(k.scores.safety) if "safety" in k.scores else "—" }}
        {% else %}
          スコア表示: —
        {% endif %}
      </div>
      <div>根拠：{{ k.rationale }}</div>
    </li>
    {% endfor %}
  </ol>
</section>

      <section>
        <h2>1剤に絞る薬剤師へのアドバイス</h2>
        <p>{{ result.pharmacist_selection_advice }}</p>
      </section>

      <section>
        <h2>薬膳材料（5つ）</h2>
        <ul class="grid2">
          {% for y in result.yakuzen_ingredients %}
          <li>{{ y.name }}<span class="small">（{{ y.effect }}）</span></li>
          {% endfor %}
        </ul>
      </section>

      <!-- ツボ（主症状向け） -->
<!-- ツボ（主症状向け） -->
<section>
  <h2>ツボ（主症状に対して）</h2>
  <p>{{ result.acupoints_advice or "今回のケースでは提案なし" }}</p>
</section>

<!-- アロマ（体質・八綱に合わせて） -->
<section>
  <h2>アロマ（体質・八綱に合わせて）</h2>
  <p>{{ result.aroma_advice or "今回のケースでは提案なし" }}</p>
</section>


      {% if result.safety_notes %}
      <section>
        <h2>安全上の注意</h2>
        <p class="warn">{{ result.safety_notes }}</p>
      </section>
      {% endif %}

      <section>
        <h2>信頼度</h2>
        <p>AIの自己評価：
          {% if result.confidence is defined %}{{ "%.2f"|format(result.confidence) }}{% else %}—{% endif %}
        </p>
      </section>
    {% endif %}

    <div class="actions">
      <a class="btn" href="/">入力に戻る</a>
    </div>

    <!-- 解析結果の下あたりに追加（detail.html） -->
<section>
  <h2>データの保存</h2>
  <div class="actions">
    <button type="button" id="dl-ai-json">AI結果(JSON)を保存</button>
    <button type="button" id="dl-form-json">入力内容(JSON)を保存</button>
    <button type="button" id="dl-csv">CSVを保存</button>
  </div>
</section>

<script>
(function(){
  // Jinja から安全にオブジェクト化
  const aiResult = {{ (result or {}) | tojson }};
  const formData = {{ (form or {}) | tojson }};

  function download(filename, content, type="application/json"){
    const blob = new Blob([content], {type});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click();
    a.remove(); URL.revokeObjectURL(url);
  }

  function toCSV(obj){
    // フラットな key,value の簡易CSV
    const rows = [];
    for (const [k, v] of Object.entries(obj)){
      const val = Array.isArray(v) ? v.join("|") : (v===null||v===undefined ? "" : String(v));
      rows.push(`"${k.replace(/"/g,'""')}","${val.replace(/"/g,'""')}"`);
    }
    return "key,value\n" + rows.join("\n");
  }

  document.getElementById("dl-ai-json")?.addEventListener("click", ()=>{
    download("ai_result.json", JSON.stringify(aiResult, null, 2));
  });
  document.getElementById("dl-form-json")?.addEventListener("click", ()=>{
    download("form_data.json", JSON.stringify(formData, null, 2));
  });
  document.getElementById("dl-csv")?.addEventListener("click", ()=>{
    // 入力とAI結果を結合してCSV化
    const merged = {...formData, _ai: aiResult};
    download("submission.csv", toCSV(merged), "text/csv");
  });
})();
</script>

  </main>
</body>
</html>
