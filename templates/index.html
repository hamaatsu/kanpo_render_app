<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>体質チェック＋主訴入力（薬剤師入力用・複数カテゴリ対応）</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:14px;line-height:1.5}
  h1{margin-bottom:8px}
  .sec{border:1px solid #e5e7eb;border-radius:12px;padding:14px;margin:12px 0;}
  .grid3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
  .grid4{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
  .cat{border:1px dashed #d1d5db;border-radius:10px;padding:10px}
  .cat h3{margin:0 0 6px 0;font-size:16px}
  .sym{display:block;margin:4px 0}
  label.inline{display:flex;gap:8px;align-items:center}
  select, textarea, input[type=text], input[type=number]{width:100%;padding:8px;border:1px solid #ccc;border-radius:8px;}
  button{padding:10px 16px;border:0;border-radius:10px;background:#2563eb;color:#fff;font-weight:700;cursor:pointer;margin-top:12px}
  button.secondary{background:#111827}
  .muted{color:#6b7280;font-size:12px}
  .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .row > *{flex:1 1 auto}
  .cards{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-top:12px}
  .card{border:1px solid #e5e7eb;border-radius:12px;padding:10px}
  .card .big{font-size:26px;font-weight:700}
  .chip{display:inline-flex;align-items:center;padding:4px 8px;border:1px solid #e5e7eb;border-radius:999px;background:#f9fafb}
  @media (max-width:980px){ .grid3,.grid4,.cards{grid-template-columns:1fr} }

  /* === Thinking Overlay / Spinner === */
  #thinkingOverlay{
    position:fixed; inset:0; background:rgba(255,255,255,.6);
    display:none; align-items:center; justify-content:center; z-index:9999;
    backdrop-filter:saturate(120%) blur(2px);
  }
  .spinner{
    width:54px; height:54px; border-radius:50%;
    border:6px solid #e5e7eb; border-top-color:#2563eb;
    animation:spin 1s linear infinite;
  }
  #thinkingText{ margin-top:12px; color:#374151; font-weight:700; text-align:center }
  @keyframes spin{to{transform:rotate(360deg)}}

  /* === ボタンの押下／無効化 表現 === */
  button:active{ transform:translateY(1px); filter:saturate(115%); }
  button[disabled]{ opacity:.6; cursor:not-allowed; }
</style>
</head>
<body>
<h1>体質チェック＋主訴入力（薬剤師入力・複数カテゴリ対応）</h1>

<!-- 基本情報 -->
<div class="sec">
  <h2>基本情報</h2>
  <div class="grid3">
    <label class="inline">お名前：<input type="text" id="name"></label>
    <label class="inline">年齢：<input type="number" id="age" style="max-width:140px">歳</label>
    <label class="inline">性別：
      <select id="gender" style="max-width:200px">
        <option value="">未選択</option>
        <option>女性</option>
        <option>男性</option>
        <option>その他/回答しない</option>
      </select>
    </label>
  </div>
  <div class="muted">※ 月経項目は女性該当者のみ使用します</div>
</div>

<!-- 主訴（大分類をまたいで複数選択可）【元の内容を維持】 -->
<div class="sec">
  <h2>主訴（大分類をまたいで複数選択可）</h2>
  <p class="muted">該当するものをすべてチェックしてください。複数カテゴリの併用可（例：生理痛＋PMS＋肩こり）。</p>

  <div class="grid4">
    <!-- 消化器・便通 -->
    <div class="cat"><h3>消化器・便通</h3>
      <label class="sym"><input type="checkbox" data-cat="消化器・便通" value="便秘"> 便秘</label>
      <label class="sym"><input type="checkbox" data-cat="消化器・便通" value="下痢"> 下痢</label>
      <label class="sym"><input type="checkbox" data-cat="消化器・便通" value="食欲不振"> 食欲不振</label>
      <label class="sym"><input type="checkbox" data-cat="消化器・便通" value="胃もたれ"> 胃もたれ</label>
      <label class="sym"><input type="checkbox" data-cat="消化器・便通" value="胸やけ"> 胸やけ</label>
      <label class="sym"><input type="checkbox" data-cat="消化器・便通" value="腹部膨満感"> 腹部膨満感</label>
      <label class="sym"><input type="checkbox" data-cat="消化器・便通" value="過敏性腸症候群"> 過敏性腸症候群</label>
    </div>

    <!-- 循環・むくみ -->
    <div class="cat"><h3>循環・むくみ</h3>
      <label class="sym"><input type="checkbox" data-cat="循環・むくみ" value="むくみ"> むくみ</label>
      <label class="sym"><input type="checkbox" data-cat="循環・むくみ" value="立ちくらみ"> 立ちくらみ</label>
      <label class="sym"><input type="checkbox" data-cat="循環・むくみ" value="動悸"> 動悸</label>
      <label class="sym"><input type="checkbox" data-cat="循環・むくみ" value="高血圧傾向"> 高血圧傾向</label>
      <label class="sym"><input type="checkbox" data-cat="循環・むくみ" value="冷え"> 冷え</label>
      <label class="sym"><input type="checkbox" data-cat="循環・むくみ" value="ほてり"> ほてり</label>
    </div>

    <!-- 体温・冷え -->
    <div class="cat"><h3>体温・冷え</h3>
      <label class="sym"><input type="checkbox" data-cat="体温・冷え" value="冷え性"> 冷え性</label>
      <label class="sym"><input type="checkbox" data-cat="体温・冷え" value="のぼせ"> のぼせ</label>
      <label class="sym"><input type="checkbox" data-cat="体温・冷え" value="手足が冷たい"> 手足が冷たい</label>
      <label class="sym"><input type="checkbox" data-cat="体温・冷え" value="手足がほてる"> 手足がほてる</label>
    </div>

    <!-- 呼吸器 -->
    <div class="cat"><h3>呼吸器</h3>
      <label class="sym"><input type="checkbox" data-cat="呼吸器" value="咳"> 咳</label>
      <label class="sym"><input type="checkbox" data-cat="呼吸器" value="痰"> 痰</label>
      <label class="sym"><input type="checkbox" data-cat="呼吸器" value="鼻水"> 鼻水</label>
      <label class="sym"><input type="checkbox" data-cat="呼吸器" value="鼻づまり"> 鼻づまり</label>
      <label class="sym"><input type="checkbox" data-cat="呼吸器" value="花粉症"> 花粉症</label>
      <label class="sym"><input type="checkbox" data-cat="呼吸器" value="風邪をひきやすい"> 風邪をひきやすい</label>
    </div>

    <!-- 皮膚・アレルギー -->
    <div class="cat"><h3>皮膚・アレルギー</h3>
      <label class="sym"><input type="checkbox" data-cat="皮膚・アレルギー" value="乾燥肌"> 乾燥肌</label>
      <label class="sym"><input type="checkbox" data-cat="皮膚・アレルギー" value="湿疹"> 湿疹</label>
      <label class="sym"><input type="checkbox" data-cat="皮膚・アレルギー" value="かゆみ"> かゆみ</label>
      <label class="sym"><input type="checkbox" data-cat="皮膚・アレルギー" value="吹き出物"> 吹き出物</label>
      <label class="sym"><input type="checkbox" data-cat="皮膚・アレルギー" value="にきび"> にきび</label>
      <label class="sym"><input type="checkbox" data-cat="皮膚・アレルギー" value="肌荒れ"> 肌荒れ</label>
    </div>

    <!-- 痛み・筋骨格 -->
    <div class="cat"><h3>痛み・筋骨格</h3>
      <label class="sym"><input type="checkbox" data-cat="痛み・筋骨格" value="肩こり"> 肩こり</label>
      <label class="sym"><input type="checkbox" data-cat="痛み・筋骨格" value="腰痛"> 腰痛</label>
      <label class="sym"><input type="checkbox" data-cat="痛み・筋骨格" value="膝痛"> 膝痛</label>
      <label class="sym"><input type="checkbox" data-cat="痛み・筋骨格" value="頭痛"> 頭痛</label>
      <label class="sym"><input type="checkbox" data-cat="痛み・筋骨格" value="首の痛み"> 首の痛み</label>
      <label class="sym"><input type="checkbox" data-cat="痛み・筋骨格" value="こむら返り"> こむら返り</label>
    </div>

    <!-- 睡眠・神経 -->
    <div class="cat"><h3>睡眠・神経</h3>
      <label class="sym"><input type="checkbox" data-cat="睡眠・神経" value="不眠"> 不眠</label>
      <label class="sym"><input type="checkbox" data-cat="睡眠・神経" value="眠りが浅い"> 眠りが浅い</label>
      <label class="sym"><input type="checkbox" data-cat="睡眠・神経" value="多夢"> 多夢</label>
      <label class="sym"><input type="checkbox" data-cat="睡眠・神経" value="寝汗"> 寝汗</label>
      <label class="sym"><input type="checkbox" data-cat="睡眠・神経" value="手足のしびれ"> 手足のしびれ</label>
      <label class="sym"><input type="checkbox" data-cat="睡眠・神経" value="めまい"> めまい</label>
    </div>

    <!-- メンタル・自律神経 -->
    <div class="cat"><h3>メンタル・自律神経</h3>
      <label class="sym"><input type="checkbox" data-cat="メンタル・自律神経" value="イライラ"> イライラ</label>
      <label class="sym"><input type="checkbox" data-cat="メンタル・自律神経" value="不安"> 不安</label>
      <label class="sym"><input type="checkbox" data-cat="メンタル・自律神経" value="抑うつ"> 抑うつ</label>
      <label class="sym"><input type="checkbox" data-cat="メンタル・自律神経" value="緊張"> 緊張</label>
      <label class="sym"><input type="checkbox" data-cat="メンタル・自律神経" value="パニック"> パニック</label>
      <label class="sym"><input type="checkbox" data-cat="メンタル・自律神経" value="動悸"> 動悸</label>
    </div>

    <!-- 体型・代謝 -->
    <div class="cat"><h3>体型・代謝</h3>
      <label class="sym"><input type="checkbox" data-cat="体型・代謝" value="疲れやすい"> 疲れやすい</label>
      <label class="sym"><input type="checkbox" data-cat="体型・代謝" value="やせやすい"> やせやすい</label>
      <label class="sym"><input type="checkbox" data-cat="体型・代謝" value="太りやすい"> 太りやすい</label>
      <label class="sym"><input type="checkbox" data-cat="体型・代謝" value="むくみやすい"> むくみやすい</label>
      <label class="sym"><input type="checkbox" data-cat="体型・代謝" value="冷え太り"> 冷え太り</label>
      <label class="sym"><input type="checkbox" data-cat="体型・代謝" value="更年期太り"> 更年期太り</label>
    </div>

    <!-- 婦人科・月経 -->
    <div class="cat"><h3>婦人科・月経</h3>
      <label class="sym"><input type="checkbox" data-cat="婦人科・月経" value="月経痛"> 月経痛</label>
      <label class="sym"><input type="checkbox" data-cat="婦人科・月経" value="PMS"> PMS</label>
      <label class="sym"><input type="checkbox" data-cat="婦人科・月経" value="更年期障害"> 更年期障害</label>
      <label class="sym"><input type="checkbox" data-cat="婦人科・月経" value="不妊"> 不妊</label>
      <label class="sym"><input type="checkbox" data-cat="婦人科・月経" value="産後不調"> 産後不調</label>
      <label class="sym"><input type="checkbox" data-cat="婦人科・月経" value="月経不順"> 月経不順</label>
    </div>

    <!-- 感染・炎症 -->
    <div class="cat"><h3>感染・炎症</h3>
      <label class="sym"><input type="checkbox" data-cat="感染・炎症" value="扁桃炎"> 扁桃炎</label>
      <label class="sym"><input type="checkbox" data-cat="感染・炎症" value="副鼻腔炎"> 副鼻腔炎</label>
      <label class="sym"><input type="checkbox" data-cat="感染・炎症" value="膀胱炎"> 膀胱炎</label>
      <label class="sym"><input type="checkbox" data-cat="感染・炎症" value="にきび炎症"> にきび炎症</label>
      <label class="sym"><input type="checkbox" data-cat="感染・炎症" value="皮膚の化膿"> 皮膚の化膿</label>
      <label class="sym"><input type="checkbox" data-cat="感染・炎症" value="発熱傾向"> 発熱傾向</label>
    </div>

    <!-- 泌尿器 -->
    <div class="cat"><h3>泌尿器</h3>
      <label class="sym"><input type="checkbox" data-cat="泌尿器" value="頻尿"> 頻尿</label>
      <label class="sym"><input type="checkbox" data-cat="泌尿器" value="残尿感"> 残尿感</label>
      <label class="sym"><input type="checkbox" data-cat="泌尿器" value="排尿痛"> 排尿痛</label>
      <label class="sym"><input type="checkbox" data-cat="泌尿器" value="夜間頻尿"> 夜間頻尿</label>
      <label class="sym"><input type="checkbox" data-cat="泌尿器" value="尿漏れ"> 尿漏れ</label>
      <label class="sym"><input type="checkbox" data-cat="泌尿器" value="むくみ"> むくみ</label>
    </div>

    <!-- 循環器（別立ても元のまま） -->
    <div class="cat"><h3>循環器</h3>
      <label class="sym"><input type="checkbox" data-cat="循環器" value="動悸"> 動悸</label>
      <label class="sym"><input type="checkbox" data-cat="循環器" value="胸のドキドキ"> 胸のドキドキ</label>
      <label class="sym"><input type="checkbox" data-cat="循環器" value="胸のつかえ"> 胸のつかえ</label>
      <label class="sym"><input type="checkbox" data-cat="循環器" value="息切れ"> 息切れ</label>
      <label class="sym"><input type="checkbox" data-cat="循環器" value="冷え"> 冷え</label>
      <label class="sym"><input type="checkbox" data-cat="循環器" value="ほてり"> ほてり</label>
    </div>

    <!-- 疲労・倦怠感 -->
    <div class="cat"><h3>疲労・倦怠感</h3>
      <label class="sym"><input type="checkbox" data-cat="疲労・倦怠感" value="疲れやすい"> 疲れやすい</label>
      <label class="sym"><input type="checkbox" data-cat="疲労・倦怠感" value="朝起きられない"> 朝起きられない</label>
      <label class="sym"><input type="checkbox" data-cat="疲労・倦怠感" value="根気が続かない"> 根気が続かない</label>
      <label class="sym"><input type="checkbox" data-cat="疲労・倦怠感" value="息切れ"> 息切れ</label>
      <label class="sym"><input type="checkbox" data-cat="疲労・倦怠感" value="冷え"> 冷え</label>
    </div>

    <!-- 体型・代謝（重複は元のまま保持） -->
    <div class="cat"><h3>体型・代謝</h3>
      <label class="sym"><input type="checkbox" data-cat="体型・代謝" value="冷え太り"> 冷え太り</label>
      <label class="sym"><input type="checkbox" data-cat="体型・代謝" value="更年期太り"> 更年期太り</label>
      <label class="sym"><input type="checkbox" data-cat="体型・代謝" value="やせやすい"> やせやすい</label>
      <label class="sym"><input type="checkbox" data-cat="体型・代謝" value="太りやすい"> 太りやすい</label>
    </div>

    <!-- メンタル・自律神経（重複も元のまま） -->
    <div class="cat"><h3>メンタル・自律神経</h3>
      <label class="sym"><input type="checkbox" data-cat="メンタル・自律神経" value="不安"> 不安</label>
      <label class="sym"><input type="checkbox" data-cat="メンタル・自律神経" value="抑うつ"> 抑うつ</label>
      <label class="sym"><input type="checkbox" data-cat="メンタル・自律神経" value="緊張"> 緊張</label>
      <label class="sym"><input type="checkbox" data-cat="メンタル・自律神経" value="イライラ"> イライラ</label>
      <label class="sym"><input type="checkbox" data-cat="メンタル・自律神経" value="めまい"> めまい</label>
    </div>

    <!-- 小児 -->
    <div class="cat"><h3>小児</h3>
      <label class="sym"><input type="checkbox" data-cat="小児" value="小児夜泣き"> 小児夜泣き</label>
      <label class="sym"><input type="checkbox" data-cat="小児" value="小児疳の虫"> 小児疳の虫</label>
      <label class="sym"><input type="checkbox" data-cat="小児" value="夜尿症"> 夜尿症</label>
      <label class="sym"><input type="checkbox" data-cat="小児" value="小児便秘"> 小児便秘</label>
      <label class="sym"><input type="checkbox" data-cat="小児" value="虚弱体質"> 虚弱体質</label>
      <label class="sym"><input type="checkbox" data-cat="小児" value="風邪をひきやすい"> 風邪をひきやすい</label>
    </div>

    <!-- その他 -->
    <div class="cat"><h3>その他</h3>
      <label class="sym"><input type="checkbox" data-cat="その他" value="該当なし"> 該当なし</label>
    </div>
  </div>

  <label style="display:block;margin-top:10px;">自由記入（具体的な症状・経過・誘因/緩和因子など）</label>
  <textarea id="chief_detail" rows="3" placeholder="例：夜になると足が冷えて眠れない。便秘とむくみが続いている。"></textarea>
</div>

<!-- 証（体質チェック：当てはまるものにチェック） -->
<div class="sec">
  <h2>体質チェック（当てはまるものにチェック）</h2>
  <div class="grid3">
    <!-- 感情・眠り -->
    <div class="cat">
      <h3>感情・眠り</h3>
      <label class="sym"><input type="checkbox" value="emo_irrit"> イライラしやすい</label>
      <label class="sym"><input type="checkbox" value="emo_angry"> 怒りっぽい</label>
      <label class="sym"><input type="checkbox" value="emo_anx"> 不安になりやすい</label>
      <label class="sym"><input type="checkbox" value="emo_tension"> 緊張しやすい</label>
      <label class="sym"><input type="checkbox" value="emo_sigh"> ため息が多い／胸がつかえる</label>
      <label class="sym"><input type="checkbox" value="sleep_dream"> 夢が多い</label>
      <label class="sym"><input type="checkbox" value="sleep_shallow"> 眠りが浅い</label>
      <label class="sym"><input type="checkbox" value="sleep_daytime"> 日中に眠くなりやすい</label>
      <label class="sym"><input type="checkbox" value="sleep_heat_insomnia"> 暑くて寝つけない</label>
    </div>

    <!-- 体の傾向 -->
    <div class="cat">
      <h3>体の傾向</h3>
      <label class="sym"><input type="checkbox" value="tend_cold"> 寒がり／手足が冷える</label>
      <label class="sym"><input type="checkbox" value="tend_flush"> 顔がのぼせやすい</label>
      <label class="sym"><input type="checkbox" value="tend_upperhot_lowercold"> 上半身が熱く下半身が冷える</label>
      <label class="sym"><input type="checkbox" value="tend_edema"> むくみやすい</label>
      <label class="sym"><input type="checkbox" value="tend_heavy"> 体が重だるい</label>
      <label class="sym"><input type="checkbox" value="tend_sweat_easily"> 汗をかきやすい</label>
      <label class="sym"><input type="checkbox" value="tend_fatigue"> 少し動くと疲れやすい</label>
      <label class="sym"><input type="checkbox" value="tend_pale"> 顔色が悪い／血の気が少ない</label>
      <label class="sym"><input type="checkbox" value="tend_dyspnea"> 息切れしやすい</label>
    </div>

    <!-- 体の状態 -->
    <div class="cat">
      <h3>体の状態</h3>
      <label class="sym"><input type="checkbox" value="stiff_shoulder"> 肩や首がこりやすい</label>
      <label class="sym"><input type="checkbox" value="fixed_pain"> 痛みが同じ場所にとどまる</label>
      <label class="sym"><input type="checkbox" value="numbness"> 手足がしびれる</label>
      <label class="sym"><input type="checkbox" value="cold_extremities"> 手足の冷えが強い</label>
      <label class="sym"><input type="checkbox" value="dry_skin"> 乾燥肌でかさつく</label>
      <label class="sym"><input type="checkbox" value="spots_dull"> シミ・くすみが気になる</label>
      <label class="sym"><input type="checkbox" value="acne_red"> ニキビ／吹き出物が出やすい</label>
      <label class="sym"><input type="checkbox" value="erythema"> 炎症や赤みが出やすい</label>
      <label class="sym"><input type="checkbox" value="flush_hot"> ほてりを感じやすい</label>
      <label class="sym"><input type="checkbox" value="night_sweat"> 夜に寝汗をかく</label>
    </div>

    <!-- 舌・口・目 -->
    <div class="cat">
      <h3>舌・口・目</h3>
      <label class="sym"><input type="checkbox" value="t_pale"> 舌が白っぽい</label>
      <label class="sym"><input type="checkbox" value="t_red"> 舌が赤い</label>
      <label class="sym"><input type="checkbox" value="t_teethmark"> 舌に歯の跡がつく</label>
      <label class="sym"><input type="checkbox" value="t_white_thick"> 舌苔が白く厚い</label>
      <label class="sym"><input type="checkbox" value="t_yellow_thick"> 舌苔が黄色く厚い</label>
      <label class="sym"><input type="checkbox" value="t_crack_dry"> 舌が乾き／ひび割れる</label>
      <label class="sym"><input type="checkbox" value="dry_mouth"> 口が渇きやすい</label>
      <label class="sym"><input type="checkbox" value="eye_fatigue"> 目が疲れやすい</label>
      <label class="sym"><input type="checkbox" value="eye_red"> 目が充血しやすい</label>
    </div>

    <!-- 消化・便通・食欲 -->
    <div class="cat">
      <h3>消化・便通・食欲</h3>
      <label class="sym"><input type="checkbox" value="poor_appetite"> 食欲が落ちやすい</label>
      <label class="sym"><input type="checkbox" value="postprandial_sleepy"> 食後に眠くなる</label>
      <label class="sym"><input type="checkbox" value="bloating"> お腹が張りやすい／胃もたれ</label>
      <label class="sym"><input type="checkbox" value="loose_stool"> 便が柔らかい／水っぽい</label>
      <label class="sym"><input type="checkbox" value="diarrhea"> 下痢しやすい</label>
      <label class="sym"><input type="checkbox" value="constipation"> 便秘しやすい</label>
      <label class="sym"><input type="checkbox" value="alt_diarrhea_constipation"> 下痢と便秘をくり返す</label>
    </div>

    <!-- 月経（該当者のみ） -->
    <div class="cat">
      <h3>月経（該当者のみ）</h3>
      <label class="sym"><input type="checkbox" value="m_cycle_short"> 月経周期が短い（25日以内）</label>
      <label class="sym"><input type="checkbox" value="m_cycle_long"> 月経周期が長い（35日以上）</label>
      <label class="sym"><input type="checkbox" value="m_cycle_irregular"> 月経周期が不安定</label>
      <label class="sym"><input type="checkbox" value="m_heavy"> 経血量が多い</label>
      <label class="sym"><input type="checkbox" value="m_light"> 経血量が少ない</label>
      <label class="sym"><input type="checkbox" value="m_bright_red"> 経血が鮮やかな赤</label>
      <label class="sym"><input type="checkbox" value="m_dark_clots"> 経血が暗い／黒っぽい・塊がある</label>
      <label class="sym"><input type="checkbox" value="m_dysmenorrhea_strong"> 月経痛が強い</label>
      <label class="sym"><input type="checkbox" value="m_warm_relief"> 温めると痛みがやわらぐ</label>
      <label class="sym"><input type="checkbox" value="m_cold_worse"> 冷えると痛みが強くなる</label>
      <label class="sym"><input type="checkbox" value="pms_breast_swelling"> 月経前に胸が張る</label>
      <label class="sym"><input type="checkbox" value="pms_irritability"> 月経前にイライラしやすい</label>
      <label class="sym"><input type="checkbox" value="pms_edema"> 月経前にむくみが出る</label>
    </div>
  </div>
</div>

<div class="sec">
  <button id="calc">体質スコアを計算して表示</button>
  <button id="sendAI" style="background:#16a34a;">AIに判定を送信</button>
  <div id="aiResult" style="margin-top:20px;"></div>
</div>

<!-- 判定結果 -->
<div class="sec">
  <h2>判定結果</h2>
  <div class="row"><span id="who" class="chip">対象者：未入力</span><span id="chief_out" class="chip">主訴：未選択</span></div>
  <div class="cards" id="cards"></div>
  <div class="muted">※ 体質スコア（0〜100）：高いほどその体質傾向が強いことを示します</div>
</div>

<script>
// ====== 主訴の収集（大分類をまたいで複数） ======
function collectChiefSelections(){
  const checked = Array.from(document.querySelectorAll('input[type="checkbox"][data-cat]:checked'));
  const byCat = new Map();
  checked.forEach(ch=>{
    const cat = ch.getAttribute('data-cat');
    const val = ch.value;
    if(!byCat.has(cat)) byCat.set(cat, []);
    byCat.get(cat).push(val);
  });
  // 画面表示用のテキスト
  const summary = Array.from(byCat.entries()).map(([cat, list])=>`${cat}：${list.join("・")}`);
  // サーバ送信用（配列の配列）
  const selections = Array.from(byCat.entries()).map(([category, symptoms])=>({category, symptoms}));
  return {summaryText: summary.join(" ｜ "), selections};
}

/* ====== 証ロジック（チェック→スコア） ======
   軸：気虚 qi_xu, 気滞 qi_zhi, 血虚 xue_xu, 瘀血 yu_xue, 水滞 shui_tai, 熱 netsu, 寒 kan, 虚 kyo, 実 jitsu */
const AXES = ["qi_xu","qi_zhi","xue_xu","yu_xue","shui_tai","netsu","kan","kyo","jitsu"];

// 症状→加点（舌 t_* は後で1.5倍）。数値は臨床的寄与の目安。
const MAP = {
  // 感情・眠り
  "emo_irrit":{qi_zhi:1,jitsu:0.5}, "emo_angry":{qi_zhi:1,jitsu:0.5},
  "emo_anx":{xue_xu:1}, "emo_tension":{qi_zhi:1},
  "emo_sigh":{qi_zhi:1}, "sleep_dream":{xue_xu:1},
  "sleep_shallow":{xue_xu:1}, "sleep_daytime":{qi_xu:1,kyo:1},
  "sleep_heat_insomnia":{netsu:1,jitsu:0.5},

  // 体の傾向
  "tend_cold":{kan:1,kyo:1}, "tend_flush":{netsu:1,jitsu:0.5},
  "tend_upperhot_lowercold":{netsu:1,kan:1,qi_zhi:1},
  "tend_edema":{shui_tai:1}, "tend_heavy":{shui_tai:1},
  "tend_sweat_easily":{qi_xu:1}, "tend_fatigue":{qi_xu:1},
  "tend_pale":{xue_xu:1}, "tend_dyspnea":{qi_xu:1},

  // 体の状態
  "stiff_shoulder":{qi_zhi:1,yu_xue:1}, "fixed_pain":{yu_xue:1,jitsu:0.5},
  "numbness":{xue_xu:1}, "cold_extremities":{kan:1},
  "dry_skin":{xue_xu:1}, "spots_dull":{yu_xue:1},
  "acne_red":{netsu:1,jitsu:0.5}, "erythema":{netsu:1},
  "flush_hot":{netsu:1}, "night_sweat":{netsu:1,kyo:0.5},

  // 舌・口・目（舌は1.5倍）
  "t_pale":{xue_xu:1,kyo:0.5}, "t_red":{netsu:1},
  "t_teethmark":{qi_xu:1,shui_tai:1},
  "t_white_thick":{shui_tai:1,kan:1}, "t_yellow_thick":{netsu:1,jitsu:0.5},
  "t_crack_dry":{xue_xu:1,netsu:1},
  "dry_mouth":{netsu:1}, "eye_fatigue":{xue_xu:1}, "eye_red":{netsu:1},

  // 消化・便通・食欲
  "poor_appetite":{qi_xu:1}, "postprandial_sleepy":{qi_xu:1},
  "bloating":{qi_zhi:1}, "loose_stool":{shui_tai:1},
  "diarrhea":{kan:0.5,shui_tai:1}, "constipation":{qi_zhi:1,yu_xue:0.5},
  "alt_diarrhea_constipation":{qi_zhi:1,shui_tai:1},

  // 月経（該当者のみ）
  "m_cycle_short":{netsu:0.5}, "m_cycle_long":{kan:0.5,xue_xu:0.5},
  "m_cycle_irregular":{qi_zhi:0.5,qi_xu:0.5},
  "m_heavy":{netsu:1,jitsu:0.5}, "m_light":{xue_xu:1},
  "m_bright_red":{netsu:0.5}, "m_dark_clots":{yu_xue:1,jitsu:0.5},
  "m_dysmenorrhea_strong":{yu_xue:0.5,qi_zhi:0.5},
  "m_warm_relief":{kan:0.5}, "m_cold_worse":{kan:0.5},
  "pms_breast_swelling":{qi_zhi:0.5}, "pms_irritability":{qi_zhi:0.5}, "pms_edema":{shui_tai:0.5}
};

// 証チェックの収集（data-cat 属性がないチェックのみ）
function gatherSelectedSho(){
  return Array.from(document.querySelectorAll('input[type="checkbox"]:not([data-cat]):checked')).map(i=>i.value);
}

// 舌1.5倍・寒熱/虚実の拮抗・下限0
function accumulate(ids){
  const s = Object.fromEntries(AXES.map(k=>[k,0]));
  ids.forEach(id=>{
    const add = MAP[id]; if(!add) return;
    const isTongue = id.startsWith('t_');
    for(const [k,v] of Object.entries(add)){
      s[k] += isTongue ? 1.5*v : v;
    }
  });
  s.netsu = Math.max(0, s.netsu - 0.5*s.kan);
  s.jitsu = Math.max(0, s.jitsu - 0.5*s.kyo);
  return s;
}

// 正規化：/5 で飽和抑制 → 0〜100（％は付けない）
const norm = x => Math.max(0, Math.min(1, x/5));
const score = x => Math.round(100*x);

// 合成：8軸の体質スコア
function composite(s){
  const QiDef   = score(norm(s.qi_xu));
  const QiStag  = score(norm(s.qi_zhi));
  const BloodDef= score(norm(s.xue_xu));
  const Stasis  = score(norm(s.yu_xue));
  const Damp    = score(norm(s.shui_tai));
  const YinDef  = score(Math.max(0, Math.min(1, 0.6*norm(s.netsu)+0.4*norm(s.kyo)-0.3*norm(s.jitsu))));
  const YangDef = score(Math.max(0, Math.min(1, norm(s.kan)+0.6*norm(s.kyo)-0.3*norm(s.jitsu))));
  const YangHeat= score(Math.max(0, Math.min(1, norm(s.netsu)+norm(s.jitsu)-0.4*norm(s.kyo))));
  return [
    ["気虚体質",QiDef],["血虚体質",BloodDef],["陰虚体質",YinDef],
    ["陽虚体質",YangDef],["気滞体質",QiStag],["瘀血体質",Stasis],
    ["水滞体質",Damp],["陽熱体質",YangHeat]
  ];
}

// 表示
function renderCards(pairs){
  document.getElementById('cards').innerHTML = pairs.map(([name,val])=>`
    <div class="card">
      <div class="muted">${name}</div>
      <div class="big">${val}</div>
      <div class="muted">体質スコア（0〜100）</div>
    </div>
  `).join('');
}

// 計算ボタン
document.getElementById('calc').textContent = '体質スコアを計算して表示';
document.getElementById('calc').onclick = ()=>{
  const ids = gatherSelectedSho();
  const s = accumulate(ids);
  const pairs = composite(s);
  renderCards(pairs);

  const who = `${document.getElementById('name').value||"（氏名未入力）"} / ${document.getElementById('age').value||"年齢未入力"}歳 / ${document.getElementById('gender').value||"性別未選択"}`;
  document.getElementById('who').textContent = `対象者：${who}`;

  const chief = collectChiefSelections();
  const detail = document.getElementById('chief_detail').value.trim();
  document.getElementById('chief_out').textContent = chief.summaryText
    ? `主訴：${chief.summaryText}（${detail||"詳細未記入"}）`
    : `主訴：未選択（${detail||"詳細未記入"}）`;
};

// ====== AI送信 ======
document.getElementById("sendAI").onclick = async (ev)=>{
  const btn = ev.currentTarget;
  try{
    setLoading(true, btn);

    const ids = gatherSelectedSho();
    const s = accumulate(ids);
    const pairs = composite(s);
    const constitution = Object.fromEntries(pairs); // 0-100（点）

    // 主訴（カテゴリ別）
    const checked = Array.from(document.querySelectorAll('input[type="checkbox"][data-cat]:checked'));
    const byCat = {};
    checked.forEach(ch=>{
      const cat = ch.getAttribute('data-cat'), val = ch.value;
      if(!byCat[cat]) byCat[cat] = [];
      byCat[cat].push(val);
    });
    const selections = Object.entries(byCat).map(([category, symptoms])=>({category, symptoms}));
    const detail = document.getElementById('chief_detail').value.trim();

    const payload = {
      name: document.getElementById('name').value,
      age: document.getElementById('age').value,
      gender: document.getElementById('gender').value,
      chief: { selections, detail },
      constitution // 0-100
    };

    const controller = new AbortController();
    const t = setTimeout(()=>controller.abort(), 60000);
    const res = await fetch("/analyze", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify(payload),
      signal: controller.signal
    }).catch(e=>{ throw new Error(e.name==='AbortError'?'タイムアウトしました':e.message); });
    clearTimeout(t);

    if(!res.ok) throw new Error(`サーバエラー (${res.status}) ${await res.text()}`);

    const result = await res.json();
    document.getElementById("aiResult").innerHTML = `
      <h3>AIによる提案結果</h3>
      <p><b>症状優先：</b> ${result.formula_symptom?.name || "-"}<br>
      <span class="muted">${result.formula_symptom?.reason || "-"}</span></p>
      <p><b>証優先：</b> ${result.formula_sho?.name || "-"}<br>
      <span class="muted">${result.formula_sho?.reason || "-"}</span></p>
      <p><b>折衷案：</b> ${result.formula_mixed?.name || "-"}<br>
      <span class="muted">${result.formula_mixed?.reason || "-"}</span></p>
      <hr>
      <h4>指導内容</h4>
      <p><b>療養の要点：</b><br>${result.guidance?.["療養の要点"] || "-"}</p>
      <p><b>おすすめ薬膳食材：</b></p>
      <ul>
        ${(result.guidance?.["おすすめ薬膳食材"] || [])
          .map(item => `<li>${item.name} — ${item.reason}</li>`)
          .join("")}
      </ul>
    `;
  }catch(err){
    document.getElementById("aiResult").innerHTML =
      `<div style="color:#b91c1c"><b>送信に失敗：</b>${String(err)}</div>`;
  }finally{
    setLoading(false, btn);
  }
};

// ====== Thinking Overlay ======
function setLoading(isLoading, btn){
  const overlay = document.getElementById('thinkingOverlay');
  const calcBtn = document.getElementById('calc');
  const sendBtn = document.getElementById('sendAI');
  if(isLoading){
    overlay.style.display = 'flex';
    calcBtn?.setAttribute('disabled','true');
    sendBtn?.setAttribute('disabled','true');
    if(btn){
      btn.dataset._orig = btn.textContent;
      btn.textContent = '送信中...';
    }
  }else{
    overlay.style.display = 'none';
    calcBtn?.removeAttribute('disabled');
    sendBtn?.removeAttribute('disabled');
    if(btn && btn.dataset._orig){
      btn.textContent = btn.dataset._orig;
      delete btn.dataset._orig;
    }
  }
}
</script>

<!-- Thinking overlay -->
<div id="thinkingOverlay" role="status" aria-live="polite" aria-busy="true">
  <div style="display:flex;flex-direction:column;align-items:center">
    <div class="spinner" aria-hidden="true"></div>
    <div id="thinkingText">AIが考えています…</div>
  </div>
</div>

</body>
</html>
