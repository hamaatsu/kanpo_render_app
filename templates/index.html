<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>体質チェック＋主訴入力（薬剤師入力用・複数カテゴリ対応）</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:14px;line-height:1.5}
  h1{margin-bottom:8px}
  .sec{border:1px solid #e5e7eb;border-radius:12px;padding:14px;margin:12px 0;}
  .grid3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
  .grid4{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
  .cat{border:1px dashed #d1d5db;border-radius:10px;padding:10px}
  .cat h3{margin:0 0 6px 0;font-size:16px}
  .sym{display:block;margin:4px 0}
  label.inline{display:flex;gap:8px;align-items:center}
  select, textarea, input[type=text], input[type=number]{width:100%;padding:8px;border:1px solid #ccc;border-radius:8px;}
  button{padding:10px 16px;border:0;border-radius:10px;background:#2563eb;color:#fff;font-weight:700;cursor:pointer;margin-top:12px;}
  .cards{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
  .card{border:1px solid #e5e7eb;border-radius:12px;padding:12px;text-align:center}
  .big{font-size:28px;font-weight:800}
  .muted{color:#6b7280;font-size:12px}
  @media(max-width:1200px){.grid4{grid-template-columns:repeat(3,1fr)}}
  @media(max-width:900px){.grid3{grid-template-columns:1fr}.grid4{grid-template-columns:1fr}.cards{grid-template-columns:repeat(2,1fr)}}

/* === Thinking Overlay / Spinner === */
#thinkingOverlay{
  position:fixed; inset:0; background:rgba(255,255,255,.6);
  display:none; align-items:center; justify-content:center; z-index:9999;
  backdrop-filter:saturate(120%) blur(2px);
}
.spinner{
  width:54px; height:54px; border-radius:50%;
  border:6px solid #e5e7eb; border-top-color:#2563eb;
  animation:spin 1s linear infinite;
}
#thinkingText{ margin-top:12px; color:#374151; font-weight:700; text-align:center }
@keyframes spin{to{transform:rotate(360deg)}}

/* === ボタンの押下／無効化 表現 === */
button:active{ transform:translateY(1px); filter:saturate(115%); }
button[disabled]{ opacity:.6; cursor:not-allowed; }

</style>
</head>
<body>
<h1>体質チェック＋主訴入力（薬剤師入力・複数カテゴリ対応）</h1>

<!-- 基本情報 -->
<div class="sec">
  <h2>基本情報</h2>
  <div class="grid3">
    <label class="inline">お名前：<input type="text" id="name"></label>
    <label class="inline">年齢：<input type="number" id="age" style="width:120px">歳</label>
    <label class="inline">性別：
      <select id="gender">
        <option value="">選択してください</option>
        <option value="女性">女性</option>
        <option value="男性">男性</option>
      </select>
    </label>
  </div>
</div>

<!-- 主訴（大分類をまたいで複数選択） -->
<div class="sec">
  <h2>主訴（大分類をまたいで複数選択可）</h2>
  <p class="muted">該当するものをすべてチェックしてください。複数カテゴリの併用可（例：生理痛＋PMS＋肩こり）。</p>

  <div class="grid4">
    <!-- 消化器・便通 -->
    <div class="cat"><h3>消化器・便通</h3>
      <label class="sym"><input type="checkbox" data-cat="消化器・便通" value="便秘"> 便秘</label>
      <label class="sym"><input type="checkbox" data-cat="消化器・便通" value="下痢"> 下痢</label>
      <label class="sym"><input type="checkbox" data-cat="消化器・便通" value="食欲不振"> 食欲不振</label>
      <label class="sym"><input type="checkbox" data-cat="消化器・便通" value="胃もたれ"> 胃もたれ</label>
      <label class="sym"><input type="checkbox" data-cat="消化器・便通" value="胸やけ"> 胸やけ</label>
      <label class="sym"><input type="checkbox" data-cat="消化器・便通" value="腹部膨満感"> 腹部膨満感</label>
      <label class="sym"><input type="checkbox" data-cat="消化器・便通" value="過敏性腸症候群"> 過敏性腸症候群</label>
    </div>

    <!-- 循環・むくみ -->
    <div class="cat"><h3>循環・むくみ</h3>
      <label class="sym"><input type="checkbox" data-cat="循環・むくみ" value="むくみ"> むくみ</label>
      <label class="sym"><input type="checkbox" data-cat="循環・むくみ" value="立ちくらみ"> 立ちくらみ</label>
      <label class="sym"><input type="checkbox" data-cat="循環・むくみ" value="動悸"> 動悸</label>
      <label class="sym"><input type="checkbox" data-cat="循環・むくみ" value="高血圧傾向"> 高血圧傾向</label>
      <label class="sym"><input type="checkbox" data-cat="循環・むくみ" value="冷え"> 冷え</label>
      <label class="sym"><input type="checkbox" data-cat="循環・むくみ" value="倦怠感"> 倦怠感</label>
    </div>

    <!-- 婦人科・月経 -->
    <div class="cat"><h3>婦人科・月経</h3>
      <label class="sym"><input type="checkbox" data-cat="婦人科・月経" value="月経痛"> 月経痛</label>
      <label class="sym"><input type="checkbox" data-cat="婦人科・月経" value="PMS"> PMS</label>
      <label class="sym"><input type="checkbox" data-cat="婦人科・月経" value="更年期障害"> 更年期障害</label>
      <label class="sym"><input type="checkbox" data-cat="婦人科・月経" value="不妊"> 不妊</label>
      <label class="sym"><input type="checkbox" data-cat="婦人科・月経" value="産後不調"> 産後不調</label>
      <label class="sym"><input type="checkbox" data-cat="婦人科・月経" value="月経不順"> 月経不順</label>
    </div>

    <!-- ストレス・気分 -->
    <div class="cat"><h3>ストレス・気分</h3>
      <label class="sym"><input type="checkbox" data-cat="ストレス・気分" value="イライラ"> イライラ</label>
      <label class="sym"><input type="checkbox" data-cat="ストレス・気分" value="抑うつ"> 抑うつ</label>
      <label class="sym"><input type="checkbox" data-cat="ストレス・気分" value="不安"> 不安</label>
      <label class="sym"><input type="checkbox" data-cat="ストレス・気分" value="パニック"> パニック</label>
      <label class="sym"><input type="checkbox" data-cat="ストレス・気分" value="緊張"> 緊張</label>
    </div>

    <!-- 睡眠・神経 -->
    <div class="cat"><h3>睡眠・神経</h3>
      <label class="sym"><input type="checkbox" data-cat="睡眠・神経" value="不眠"> 不眠</label>
      <label class="sym"><input type="checkbox" data-cat="睡眠・神経" value="寝つきが悪い"> 寝つきが悪い</label>
      <label class="sym"><input type="checkbox" data-cat="睡眠・神経" value="途中覚醒"> 途中覚醒</label>
      <label class="sym"><input type="checkbox" data-cat="睡眠・神経" value="朝起きられない"> 朝起きられない</label>
      <label class="sym"><input type="checkbox" data-cat="睡眠・神経" value="神経過敏"> 神経過敏</label>
      <label class="sym"><input type="checkbox" data-cat="睡眠・神経" value="夢が多い"> 夢が多い</label>
    </div>

    <!-- 皮膚・アレルギー -->
    <div class="cat"><h3>皮膚・アレルギー</h3>
      <label class="sym"><input type="checkbox" data-cat="皮膚・アレルギー" value="アトピー"> アトピー</label>
      <label class="sym"><input type="checkbox" data-cat="皮膚・アレルギー" value="湿疹"> 湿疹</label>
      <label class="sym"><input type="checkbox" data-cat="皮膚・アレルギー" value="ニキビ"> ニキビ</label>
      <label class="sym"><input type="checkbox" data-cat="皮膚・アレルギー" value="蕁麻疹"> 蕁麻疹</label>
      <label class="sym"><input type="checkbox" data-cat="皮膚・アレルギー" value="かゆみ"> かゆみ</label>
      <label class="sym"><input type="checkbox" data-cat="皮膚・アレルギー" value="乾燥肌"> 乾燥肌</label>
    </div>

    <!-- 呼吸器 -->
    <div class="cat"><h3>呼吸器</h3>
      <label class="sym"><input type="checkbox" data-cat="呼吸器" value="咳"> 咳</label>
      <label class="sym"><input type="checkbox" data-cat="呼吸器" value="痰"> 痰</label>
      <label class="sym"><input type="checkbox" data-cat="呼吸器" value="喉の痛み"> 喉の痛み</label>
      <label class="sym"><input type="checkbox" data-cat="呼吸器" value="花粉症"> 花粉症</label>
      <label class="sym"><input type="checkbox" data-cat="呼吸器" value="喘息"> 喘息</label>
      <label class="sym"><input type="checkbox" data-cat="呼吸器" value="鼻水"> 鼻水</label>
      <label class="sym"><input type="checkbox" data-cat="呼吸器" value="鼻づまり"> 鼻づまり</label>
    </div>

    <!-- 疲労・倦怠感 -->
    <div class="cat"><h3>疲労・倦怠感</h3>
      <label class="sym"><input type="checkbox" data-cat="疲労・倦怠感" value="疲れやすい"> 疲れやすい</label>
      <label class="sym"><input type="checkbox" data-cat="疲労・倦怠感" value="だるい"> だるい</label>
      <label class="sym"><input type="checkbox" data-cat="疲労・倦怠感" value="集中力低下"> 集中力低下</label>
      <label class="sym"><input type="checkbox" data-cat="疲労・倦怠感" value="倦怠感"> 倦怠感</label>
    </div>

    <!-- 体型・代謝 -->
    <div class="cat"><h3>体型・代謝</h3>
      <label class="sym"><input type="checkbox" data-cat="体型・代謝" value="むくみ太り"> むくみ太り</label>
      <label class="sym"><input type="checkbox" data-cat="体型・代謝" value="代謝低下"> 代謝低下</label>
      <label class="sym"><input type="checkbox" data-cat="体型・代謝" value="食べすぎ"> 食べすぎ</label>
      <label class="sym"><input type="checkbox" data-cat="体型・代謝" value="痩せにくい"> 痩せにくい</label>
    </div>

    <!-- 痛み・筋骨格 -->
    <div class="cat"><h3>痛み・筋骨格</h3>
      <label class="sym"><input type="checkbox" data-cat="痛み・筋骨格" value="肩こり"> 肩こり</label>
      <label class="sym"><input type="checkbox" data-cat="痛み・筋骨格" value="頭痛"> 頭痛</label>
      <label class="sym"><input type="checkbox" data-cat="痛み・筋骨格" value="腰痛"> 腰痛</label>
      <label class="sym"><input type="checkbox" data-cat="痛み・筋骨格" value="関節痛"> 関節痛</label>
      <label class="sym"><input type="checkbox" data-cat="痛み・筋骨格" value="神経痛"> 神経痛</label>
    </div>

    <!-- 泌尿器 -->
    <div class="cat"><h3>泌尿器</h3>
      <label class="sym"><input type="checkbox" data-cat="泌尿器" value="頻尿"> 頻尿</label>
      <label class="sym"><input type="checkbox" data-cat="泌尿器" value="残尿感"> 残尿感</label>
      <label class="sym"><input type="checkbox" data-cat="泌尿器" value="膀胱炎"> 膀胱炎</label>
      <label class="sym"><input type="checkbox" data-cat="泌尿器" value="夜間尿"> 夜間尿</label>
      <label class="sym"><input type="checkbox" data-cat="泌尿器" value="尿漏れ"> 尿漏れ</label>
    </div>

    <!-- 体温・冷え -->
    <div class="cat"><h3>体温・冷え</h3>
      <label class="sym"><input type="checkbox" data-cat="体温・冷え" value="冷え性"> 冷え性</label>
      <label class="sym"><input type="checkbox" data-cat="体温・冷え" value="手足の冷え"> 手足の冷え</label>
      <label class="sym"><input type="checkbox" data-cat="体温・冷え" value="寒がり"> 寒がり</label>
      <label class="sym"><input type="checkbox" data-cat="体温・冷え" value="低体温"> 低体温</label>
      <label class="sym"><input type="checkbox" data-cat="体温・冷え" value="のぼせ"> のぼせ</label>
    </div>

    <!-- 感染・炎症 -->
    <div class="cat"><h3>感染・炎症</h3>
      <label class="sym"><input type="checkbox" data-cat="感染・炎症" value="風邪"> 風邪</label>
      <label class="sym"><input type="checkbox" data-cat="感染・炎症" value="喉の痛み"> 喉の痛み</label>
      <label class="sym"><input type="checkbox" data-cat="感染・炎症" value="発熱"> 発熱</label>
      <label class="sym"><input type="checkbox" data-cat="感染・炎症" value="免疫低下"> 免疫低下</label>
    </div>

    <!-- メンタル・自律神経 -->
    <div class="cat"><h3>メンタル・自律神経</h3>
      <label class="sym"><input type="checkbox" data-cat="メンタル・自律神経" value="動悸"> 動悸</label>
      <label class="sym"><input type="checkbox" data-cat="メンタル・自律神経" value="息苦しさ"> 息苦しさ</label>
      <label class="sym"><input type="checkbox" data-cat="メンタル・自律神経" value="ほてり"> ほてり</label>
      <label class="sym"><input type="checkbox" data-cat="メンタル・自律神経" value="不安感"> 不安感</label>
      <label class="sym"><input type="checkbox" data-cat="メンタル・自律神経" value="めまい"> めまい</label>
    </div>

    <!-- 小児 -->
    <div class="cat"><h3>小児</h3>
      <label class="sym"><input type="checkbox" data-cat="小児" value="小児夜泣き"> 小児夜泣き</label>
      <label class="sym"><input type="checkbox" data-cat="小児" value="小児疳の虫"> 小児疳の虫</label>
      <label class="sym"><input type="checkbox" data-cat="小児" value="夜尿症"> 夜尿症</label>
      <label class="sym"><input type="checkbox" data-cat="小児" value="小児便秘"> 小児便秘</label>
      <label class="sym"><input type="checkbox" data-cat="小児" value="虚弱体質"> 虚弱体質</label>
      <label class="sym"><input type="checkbox" data-cat="小児" value="風邪をひきやすい"> 風邪をひきやすい</label>
    </div>

    <!-- その他 -->
    <div class="cat"><h3>その他</h3>
      <label class="sym"><input type="checkbox" data-cat="その他" value="該当なし"> 該当なし</label>
    </div>
  </div>

  <label style="display:block;margin-top:10px;">自由記入（具体的な症状・経過・誘因/緩和因子など）</label>
  <textarea id="chief_detail" rows="3" placeholder="例：夜になると足が冷えて眠れない。便秘とむくみが続いている。"></textarea>
</div>

<!-- 証（体質チェック：あなたのMAPロジック） -->
<div class="sec">
  <h2>体質チェック（当てはまるものにチェック）</h2>
  <div class="grid3">
    <div class="cat">
      <h3>感情・眠り</h3>
      <label class="sym"><input type="checkbox" value="emo_irrit"> イライラしやすい・怒りっぽい</label>
      <label class="sym"><input type="checkbox" value="emo_anx"> 不安・緊張が続きやすい</label>
      <label class="sym"><input type="checkbox" value="emo_sigh"> ため息が多い/胸がつかえる</label>
      <label class="sym"><input type="checkbox" value="emo_dream"> 夢が多く眠りが浅い</label>
      <label class="sym"><input type="checkbox" value="emo_day_sleepy"> 日中眠くなりやすい</label>
      <label class="sym"><input type="checkbox" value="emo_insomnia_heat"> 暑くて寝つけない</label>
    </div>
    <div class="cat">
      <h3>体の傾向</h3>
      <label class="sym"><input type="checkbox" value="tend_cold"> 寒さに弱い/冷えやすい</label>
      <label class="sym"><input type="checkbox" value="tend_hot_flush"> 顔が赤くのぼせやすい</label>
      <label class="sym"><input type="checkbox" value="tend_upperhot_lowercold"> 上熱下冷（上半身は熱、下は冷える）</label>
      <label class="sym"><input type="checkbox" value="tend_edema"> むくみやすい/重だるい</label>
      <label class="sym"><input type="checkbox" value="tend_sweat_tired"> 汗をかきやすく疲れやすい</label>
    </div>
    <div class="cat">
      <h3>体の状態</h3>
      <label class="sym"><input type="checkbox" value="state_dry_skin"> 乾燥肌/しわ/かさつき</label>
      <label class="sym"><input type="checkbox" value="state_red_acne"> 赤み/ニキビ/炎症が出やすい</label>
      <label class="sym"><input type="checkbox" value="state_dark_spots"> 顔色が暗い・シミが目立つ</label>
      <label class="sym"><input type="checkbox" value="state_warts_eczema"> イボ・湿疹が出やすい</label>
      <label class="sym"><input type="checkbox" value="state_hair_white"> 同年代より白髪が多い</label>
    </div>
    <div class="cat">
      <h3>顔・目</h3>
      <label class="sym"><input type="checkbox" value="face_pale"> 顔色が白い/血色がない</label>
      <label class="sym"><input type="checkbox" value="face_dull"> 顔色がくすむ</label>
      <label class="sym"><input type="checkbox" value="eye_dry"> 目が乾く（ドライアイ）</label>
      <label class="sym"><input type="checkbox" value="eye_red"> 目が充血しやすい</label>
    </div>
    <div class="cat">
      <h3>口・呼吸</h3>
      <label class="sym"><input type="checkbox" value="mouth_thirst"> 口が渇きやすい</label>
      <label class="sym"><input type="checkbox" value="mouth_bitter"> 口苦/辛いもので悪化</label>
      <label class="sym"><input type="checkbox" value="phlegm_many"> 痰が多い/ねばつく</label>
      <label class="sym"><input type="checkbox" value="throat_globus"> のどが詰まる感じがある</label>
    </div>
    <div class="cat">
      <h3>首・肩・手・足</h3>
      <label class="sym"><input type="checkbox" value="neck_stiff_headache"> 肩こり・頭痛が出やすい</label>
      <label class="sym"><input type="checkbox" value="handfoot_cold"> 手足が冷える</label>
      <label class="sym"><input type="checkbox" value="palm_sole_hot"> 手のひら/足の裏がほてる</label>
      <label class="sym"><input type="checkbox" value="leg_heavy"> 下半身がむくみやすい</label>
    </div>
    <div class="cat">
      <h3>おなか・便</h3>
      <label class="sym"><input type="checkbox" value="abd_postprandial_dull"> 食後だるい/胃もたれ</label>
      <label class="sym"><input type="checkbox" value="abd_constipation"> 便秘/硬い/出にくい</label>
      <label class="sym"><input type="checkbox" value="abd_diarrhea_cold"> 下痢/冷たい飲食で悪化</label>
      <label class="sym"><input type="checkbox" value="abd_fullness_ribside"> 胃のつかえ/胸脇が張る</label>
    </div>
    <div class="cat">
      <h3>月経（該当者のみ）</h3>
      <label class="sym"><input type="checkbox" value="m_less"> 経血少ない/色が薄い</label>
      <label class="sym"><input type="checkbox" value="m_clots"> 塊が混じる/暗色/刺す痛み</label>
      <label class="sym"><input type="checkbox" value="m_pms_stress"> 月経前に張ってイライラ</label>
      <label class="sym"><input type="checkbox" value="m_warm_relief"> 温めると楽</label>
      <label class="sym"><input type="checkbox" value="m_bright_red"> 鮮やかな赤で多い</label>
    </div>
    <div class="cat">
      <h3>舌の所見</h3>
      <label class="sym"><input type="checkbox" value="t_pale"> 淡い/痩せ気味</label>
      <label class="sym"><input type="checkbox" value="t_purple_vein"> 裏の静脈が暗く太い</label>
      <label class="sym"><input type="checkbox" value="t_white_thick"> 白い厚い苔</label>
      <label class="sym"><input type="checkbox" value="t_yellow_thick"> 黄色い厚い苔</label>
      <label class="sym"><input type="checkbox" value="t_teethmark"> 歯痕がある/はれぼったい</label>
      <label class="sym"><input type="checkbox" value="t_crack_red_dry"> 赤く乾いてひび割れ</label>
    </div>
  </div>
</div>

<div class="sec">
  <button id="calc">体質％を計算して表示</button>
  <button id="sendAI" style="background:#16a34a;">AIに判定を送信</button>
  <div id="aiResult" style="margin-top:20px;"></div>
</div>

<!-- 結果表示 -->
<div class="sec">
  <h2>結果表示</h2>
  <div class="cards" id="cards"></div>
  <div class="muted" id="who"></div>
  <div class="muted" id="chief_out"></div>
</div>

<script>
// ====== 主訴の収集（大分類をまたいで複数） ======
function collectChiefSelections(){
  const checked = Array.from(document.querySelectorAll('input[type="checkbox"][data-cat]:checked'));
  const byCat = new Map();
  checked.forEach(ch=>{
    const cat = ch.getAttribute('data-cat');
    const val = ch.value;
    if(!byCat.has(cat)) byCat.set(cat, []);
    byCat.get(cat).push(val);
  });
  // 画面表示用のテキスト
  const summary = Array.from(byCat.entries()).map(([cat, list])=>`${cat}：${list.join("・")}`);
  // サーバ送信用（配列の配列）
  const selections = Array.from(byCat.entries()).map(([category, symptoms])=>({category, symptoms}));
  return {summaryText: summary.join(" ｜ "), selections};
}

// ====== 証ロジック（あなたのMAPをそのまま使用） ======
const MAP = {
  "emo_irrit":{qi_zhi:1,jitsu:1}, "emo_anx":{xue_xu:1}, "emo_sigh":{qi_zhi:1},
  "emo_dream":{xue_xu:1}, "emo_day_sleepy":{qi_xu:1,kyo:1}, "emo_insomnia_heat":{netsu:1,jitsu:1},
  "tend_cold":{kan:1,kyo:1}, "tend_hot_flush":{netsu:1,jitsu:1},
  "tend_upperhot_lowercold":{netsu:1,kan:1,qi_zhi:1},
  "tend_edema":{shui_tai:1}, "tend_sweat_tired":{qi_xu:1},
  "state_dry_skin":{xue_xu:1}, "state_red_acne":{netsu:2,jitsu:1},
  "state_dark_spots":{yu_xue:2}, "state_warts_eczema":{shui_tai:1}, "state_hair_white":{xue_xu:1},
  "face_pale":{xue_xu:1}, "face_dull":{yu_xue:1}, "eye_dry":{xue_xu:1}, "eye_red":{netsu:1},
  "mouth_thirst":{netsu:1}, "mouth_bitter":{netsu:1}, "phlegm_many":{shui_tai:1},
  "throat_globus":{qi_zhi:1},
  "neck_stiff_headache":{qi_zhi:1,yu_xue:1}, "handfoot_cold":{kan:1},
  "palm_sole_hot":{netsu:1}, "leg_heavy":{shui_tai:1},
  "abd_postprandial_dull":{qi_xu:1}, "abd_constipation":{qi_zhi:1,yu_xue:1},
  "abd_diarrhea_cold":{kan:1,shui_tai:1,kyo:1}, "abd_fullness_ribside":{qi_zhi:2},
  "m_less":{xue_xu:1}, "m_clots":{yu_xue:2,jitsu:1}, "m_pms_stress":{qi_zhi:2},
  "m_warm_relief":{kan:1}, "m_bright_red":{netsu:1},
  "t_pale":{xue_xu:1,kyo:1}, "t_purple_vein":{yu_xue:1},
  "t_white_thick":{shui_tai:1,kan:1}, "t_yellow_thick":{netsu:1,jitsu:1},
  "t_teethmark":{qi_xu:1,shui_tai:1}, "t_crack_red_dry":{xue_xu:1,netsu:1}
};
const AXES = ["qi_xu","qi_zhi","xue_xu","yu_xue","shui_tai","netsu","kan","kyo","jitsu"];
const norm = x => Math.max(0, Math.min(1, x/3));
const pct  = x => Math.round(100*x);
function gatherSelectedSho(){ return Array.from(document.querySelectorAll('input[type="checkbox"]:not([data-cat]):checked')).map(i=>i.value); }
function accumulate(ids){
  const s=Object.fromEntries(AXES.map(k=>[k,0]));
  ids.forEach(id=>{ const a=MAP[id]; if(!a) return; for(const[k,v] of Object.entries(a)) s[k]+=v; });
  return s;
}
function composite(scores){
  const QiDef=pct(norm(scores.qi_xu)),QiStag=pct(norm(scores.qi_zhi)),BloodDef=pct(norm(scores.xue_xu)),
        Stasis=pct(norm(scores.yu_xue)),Damp=pct(norm(scores.shui_tai));
  const YinDef = pct(Math.max(0, Math.min(1, 0.6*norm(scores.netsu)+0.4*norm(scores.kyo)-0.3*norm(scores.jitsu))));
  const YangDef= pct(Math.max(0, Math.min(1, norm(scores.kan)+0.6*norm(scores.kyo)-0.3*norm(scores.jitsu))));
  const YangHeat = pct(Math.max(0, Math.min(1, norm(scores.netsu)+norm(scores.jitsu)-0.4*norm(scores.kyo))));
  return [
    ["気虚体質",QiDef],["血虚体質",BloodDef],["陰虚体質",YinDef],
    ["陽虚体質",YangDef],["気滞体質",QiStag],["瘀血体質",Stasis],
    ["水滞体質",Damp],["陽熱体質",YangHeat]
  ];
}
function renderCards(pairs){
  document.getElementById('cards').innerHTML = pairs.map(([name,val])=>`
    <div class="card"><div class="muted">${name}</div><div class="big">${val}%</div></div>
  `).join('');
}

// 体質％計算ボタン
document.getElementById('calc').onclick = ()=>{
  const ids = gatherSelectedSho();
  const scores = accumulate(ids);
  const pairs = composite(scores);
  renderCards(pairs);

  const who = `${document.getElementById('name').value||"（氏名未入力）"} / ${document.getElementById('age').value||"年齢未入力"}歳 / ${document.getElementById('gender').value||"性別未選択"}`;
  document.getElementById('who').textContent = `対象者：${who}`;

  const chief = collectChiefSelections();
  const detail = document.getElementById('chief_detail').value.trim();
  document.getElementById('chief_out').textContent = chief.summaryText
    ? `主訴：${chief.summaryText}（${detail||"詳細未記入"}）`
    : `主訴：未選択（${detail||"詳細未記入"}）`;
};

// AI送信ボタン
document.getElementById("sendAI").onclick = async (ev)=>{
  const btn = ev.currentTarget;
  try{
    setLoading(true, btn);

    // === 体質％（既存ロジック） ===
    const ids = gatherSelectedSho();
    const scores = accumulate(ids);
    const pairs = composite(scores);
    const constitution = Object.fromEntries(pairs);

    // === 主訴（カテゴリ横断の複数選択・既存ロジック）===
    const checked = Array.from(document.querySelectorAll('input[type="checkbox"][data-cat]:checked'));
    const byCat = {};
    checked.forEach(ch=>{
      const cat = ch.getAttribute('data-cat'), val = ch.value;
      if(!byCat[cat]) byCat[cat] = [];
      byCat[cat].push(val);
    });
    const selections = Object.entries(byCat).map(([category, symptoms])=>({category, symptoms}));
    const detail = document.getElementById('chief_detail').value.trim();

    const payload = {
      name: document.getElementById('name').value,
      age: document.getElementById('age').value,
      gender: document.getElementById('gender').value,
      chief: { selections, detail },
      constitution
    };

    // 送信（タイムアウト保険付き）
    const controller = new AbortController();
    const t = setTimeout(()=>controller.abort(), 60000); // 60秒で中断
    const res = await fetch("/analyze", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify(payload),
      signal: controller.signal
    }).catch(e=>{ throw new Error(e.name === 'AbortError' ? 'タイムアウトしました' : e.message); });
    clearTimeout(t);

    if(!res.ok){
      const text = await res.text();
      throw new Error(`サーバエラー (${res.status}) ${text}`);
    }

    const result = await res.json();
    document.getElementById("aiResult").innerHTML = `
      <h3>AIによる提案結果</h3>
      <p><b>症状優先：</b> ${result.formula_symptom?.name||"-"}<br>
      <span class="muted">${result.formula_symptom?.reason||"-"}</span></p>
      <p><b>証優先：</b> ${result.formula_sho?.name||"-"}<br>
      <span class="muted">${result.formula_sho?.reason||"-"}</span></p>
      <p><b>折衷案：</b> ${result.formula_mixed?.name||"-"}<br>
      <span class="muted">${result.formula_mixed?.reason||"-"}</span></p>
      <hr>
      <p><b>薬剤師コメント：</b><br>${result.pharmacist_advice||"-"}</p>
    `;
  }catch(err){
    document.getElementById("aiResult").innerHTML =
      `<div style="color:#b91c1c"><b>送信に失敗：</b>${String(err)}</div>`;
  }finally{
    setLoading(false, btn);
  }
};

// === ローディング制御 ===
function setLoading(isLoading, btn){
  const overlay = document.getElementById('thinkingOverlay');
  const calcBtn = document.getElementById('calc');
  const sendBtn = document.getElementById('sendAI');

  if(isLoading){
    overlay.style.display = 'flex';
    calcBtn?.setAttribute('disabled','true');
    sendBtn?.setAttribute('disabled','true');
    if(btn){
      btn.dataset._orig = btn.textContent;
      btn.textContent = '送信中…';
    }
  }else{
    overlay.style.display = 'none';
    calcBtn?.removeAttribute('disabled');
    sendBtn?.removeAttribute('disabled');
    if(btn && btn.dataset._orig){
      btn.textContent = btn.dataset._orig;
      delete btn.dataset._orig;
    }
  }
}

</script>
<!-- Thinking overlay -->
<div id="thinkingOverlay" role="status" aria-live="polite" aria-busy="true">
  <div style="display:flex;flex-direction:column;align-items:center">
    <div class="spinner" aria-hidden="true"></div>
    <div id="thinkingText">AIが考えています…</div>
  </div>
</div>

</body>
</html>
