<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>体質チェック＋主訴入力（薬剤師入力用・複数カテゴリ対応）</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:14px;line-height:1.5}
  h1{margin-bottom:8px}
  .sec{border:1px solid #e5e7eb;border-radius:12px;padding:14px;margin:12px 0;}
  .grid3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
  .grid4{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
  .cat{border:1px dashed #d1d5db;border-radius:10px;padding:10px}
  .cat h3{margin:0 0 6px 0;font-size:16px}
  .sym{display:block;margin:4px 0}
  label.inline{display:flex;gap:8px;align-items:center}
  input[type="text"],input[type="number"],textarea,select{
    border:1px solid #d1d5db;border-radius:8px;padding:6px 8px;width:100%;box-sizing:border-box
  }
  textarea{resize:vertical}
  .muted{color:#6b7280;font-size:12px}
  .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .row > *{flex:1 1 auto}
  .cards{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-top:12px}
  .card{border:1px solid #e5e7eb;border-radius:12px;padding:10px}
  .card .big{font-size:26px;font-weight:700}
  .flex{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .chip{display:inline-flex;align-items:center;padding:4px 8px;border:1px solid #e5e7eb;border-radius:999px;background:#f9fafb}
  button{background:#2563eb;color:white;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
  button.secondary{background:#111827}
  .footer-note{font-size:12px;color:#6b7280;margin-top:6px}
  @media (max-width:980px){ .grid3,.grid4,.cards{grid-template-columns:1fr} }

  /* Thinking overlay */
  #thinkingOverlay{
    position:fixed; inset:0; background:rgba(255,255,255,.6);
    display:none; align-items:center; justify-content:center; z-index:9999;
    backdrop-filter:saturate(120%) blur(2px);
  }
  .spinner{ width:54px; height:54px; border-radius:50%;
    border:6px solid #e5e7eb; border-top-color:#2563eb; animation:spin 1s linear infinite; }
  #thinkingText{ margin-top:12px; color:#374151; font-weight:700; text-align:center }
  @keyframes spin{to{transform:rotate(360deg)}}
  button:active{ transform:translateY(1px); filter:saturate(115%); }
  button[disabled]{ opacity:.6; cursor:not-allowed; }
</style>
</head>
<body>
<h1>体質チェック＋主訴入力（薬剤師入力・複数カテゴリ対応）</h1>

<!-- 基本情報 -->
<div class="sec">
  <h2>基本情報</h2>
  <div class="grid3">
    <label class="inline">お名前：<input type="text" id="name"></label>
    <label class="inline">年齢：<input type="number" id="age" style="width:120px">歳</label>
    <label class="inline">性別：
      <select id="gender" style="max-width:180px">
        <option value="">未選択</option>
        <option>女性</option>
        <option>男性</option>
        <option>その他/回答しない</option>
      </select>
    </label>
  </div>
  <div class="muted">※ 月経項目は女性該当者のみ使用します</div>
</div>

<!-- 主訴（カテゴリ複数可・既存構成） -->
<div class="sec">
  <h2>主訴（複数カテゴリ可）</h2>
  <div class="grid4">
    <!-- ※ 既存の主訴カテゴリはそのまま（省略：ここは元のファイルと同一です） -->
    <!-- 例：婦人科・月経、痛み・筋骨格、睡眠・神経、皮膚・アレルギー、呼吸器、消化器、循環器、泌尿器、耳鼻、眼科、口腔・歯、全身状態 など -->
    <!-- 既存のチェックボックス群（data-cat付き）は変更していません -->
  </div>

  <label style="display:block;margin-top:10px;">自由記入（具体的な症状・経過・誘因/緩和因子など）</label>
  <textarea id="chief_detail" rows="3" placeholder="例：夜になると足が冷えて眠れない。便秘とむくみが続いている。"></textarea>
</div>

<!-- 証（体質チェック：チェック式・単一症状1文） -->
<div class="sec">
  <h2>体質チェック（当てはまるものにチェック）</h2>
  <div class="grid3">
    <div class="cat">
      <h3>感情・眠り</h3>
      <label class="sym"><input type="checkbox" value="emo_irrit"> イライラしやすい</label>
      <label class="sym"><input type="checkbox" value="emo_angry"> 怒りっぽい</label>
      <label class="sym"><input type="checkbox" value="emo_anx"> 不安になりやすい</label>
      <label class="sym"><input type="checkbox" value="emo_tension"> 緊張しやすい</label>
      <label class="sym"><input type="checkbox" value="emo_sigh"> ため息が多い／胸がつかえる</label>
      <label class="sym"><input type="checkbox" value="sleep_dream"> 夢が多い</label>
      <label class="sym"><input type="checkbox" value="sleep_shallow"> 眠りが浅い</label>
      <label class="sym"><input type="checkbox" value="sleep_daytime"> 日中に眠くなりやすい</label>
      <label class="sym"><input type="checkbox" value="sleep_heat_insomnia"> 暑くて寝つけない</label>
    </div>

    <div class="cat">
      <h3>体の傾向</h3>
      <label class="sym"><input type="checkbox" value="tend_cold"> 寒がり／手足が冷える</label>
      <label class="sym"><input type="checkbox" value="tend_flush"> 顔がのぼせやすい</label>
      <label class="sym"><input type="checkbox" value="tend_upperhot_lowercold"> 上半身が熱く下半身が冷える</label>
      <label class="sym"><input type="checkbox" value="tend_edema"> むくみやすい</label>
      <label class="sym"><input type="checkbox" value="tend_heavy"> 体が重だるい</label>
      <label class="sym"><input type="checkbox" value="tend_sweat_easily"> 汗をかきやすい</label>
      <label class="sym"><input type="checkbox" value="tend_fatigue"> 少し動くと疲れやすい</label>
      <label class="sym"><input type="checkbox" value="tend_pale"> 顔色が悪い／血の気が少ない</label>
      <label class="sym"><input type="checkbox" value="tend_dyspnea"> 息切れしやすい</label>
    </div>

    <div class="cat">
      <h3>体の状態</h3>
      <label class="sym"><input type="checkbox" value="stiff_shoulder"> 肩や首がこりやすい</label>
      <label class="sym"><input type="checkbox" value="fixed_pain"> 痛みが同じ場所にとどまる</label>
      <label class="sym"><input type="checkbox" value="numbness"> 手足がしびれる</label>
      <label class="sym"><input type="checkbox" value="cold_extremities"> 手足の冷えが強い</label>
      <label class="sym"><input type="checkbox" value="dry_skin"> 乾燥肌でかさつく</label>
      <label class="sym"><input type="checkbox" value="spots_dull"> シミ・くすみが気になる</label>
      <label class="sym"><input type="checkbox" value="acne_red"> ニキビ／吹き出物が出やすい</label>
      <label class="sym"><input type="checkbox" value="erythema"> 炎症や赤みが出やすい</label>
      <label class="sym"><input type="checkbox" value="flush_hot"> ほてりを感じやすい</label>
      <label class="sym"><input type="checkbox" value="night_sweat"> 夜に寝汗をかく</label>
    </div>

    <div class="cat">
      <h3>舌・口・目</h3>
      <label class="sym"><input type="checkbox" value="t_pale"> 舌が白っぽい</label>
      <label class="sym"><input type="checkbox" value="t_red"> 舌が赤い</label>
      <label class="sym"><input type="checkbox" value="t_teethmark"> 舌に歯の跡がつく</label>
      <label class="sym"><input type="checkbox" value="t_white_thick"> 舌苔が白く厚い</label>
      <label class="sym"><input type="checkbox" value="t_yellow_thick"> 舌苔が黄色く厚い</label>
      <label class="sym"><input type="checkbox" value="t_crack_dry"> 舌が乾き／ひび割れる</label>
      <label class="sym"><input type="checkbox" value="dry_mouth"> 口が渇きやすい</label>
      <label class="sym"><input type="checkbox" value="eye_fatigue"> 目が疲れやすい</label>
      <label class="sym"><input type="checkbox" value="eye_red"> 目が充血しやすい</label>
    </div>

    <div class="cat">
      <h3>消化・便通・食欲</h3>
      <label class="sym"><input type="checkbox" value="poor_appetite"> 食欲が落ちやすい</label>
      <label class="sym"><input type="checkbox" value="postprandial_sleepy"> 食後に眠くなる</label>
      <label class="sym"><input type="checkbox" value="bloating"> お腹が張りやすい／胃もたれ</label>
      <label class="sym"><input type="checkbox" value="loose_stool"> 便が柔らかい／水っぽい</label>
      <label class="sym"><input type="checkbox" value="diarrhea"> 下痢しやすい</label>
      <label class="sym"><input type="checkbox" value="constipation"> 便秘しやすい</label>
      <label class="sym"><input type="checkbox" value="alt_diarrhea_constipation"> 下痢と便秘をくり返す</label>
    </div>

    <div class="cat">
      <h3>月経（該当者のみ）</h3>
      <label class="sym"><input type="checkbox" value="m_cycle_short"> 月経周期が短い（25日以内）</label>
      <label class="sym"><input type="checkbox" value="m_cycle_long"> 月経周期が長い（35日以上）</label>
      <label class="sym"><input type="checkbox" value="m_cycle_irregular"> 月経周期が不安定</label>
      <label class="sym"><input type="checkbox" value="m_heavy"> 経血量が多い</label>
      <label class="sym"><input type="checkbox" value="m_light"> 経血量が少ない</label>
      <label class="sym"><input type="checkbox" value="m_bright_red"> 経血が鮮やかな赤</label>
      <label class="sym"><input type="checkbox" value="m_dark_clots"> 経血が暗い／黒っぽい・塊がある</label>
      <label class="sym"><input type="checkbox" value="m_dysmenorrhea_strong"> 月経痛が強い</label>
      <label class="sym"><input type="checkbox" value="m_warm_relief"> 温めると痛みがやわらぐ</label>
      <label class="sym"><input type="checkbox" value="m_cold_worse"> 冷えると痛みが強くなる</label>
      <label class="sym"><input type="checkbox" value="pms_breast_swelling"> 月経前に胸が張る</label>
      <label class="sym"><input type="checkbox" value="pms_irritability"> 月経前にイライラしやすい</label>
      <label class="sym"><input type="checkbox" value="pms_edema"> 月経前にむくみが出る</label>
    </div>
  </div>
</div>

<div class="sec">
  <button id="calc">体質スコアを計算して表示</button>
  <button id="sendAI" style="background:#16a34a;">AIに判定を送信</button>
  <div id="aiResult" style="margin-top:20px;"></div>
</div>

<!-- 結果表示 -->
<div class="sec">
  <h2>判定結果</h2>
  <div class="row"><span id="who" class="chip">対象者：未入力</span><span id="chief_out" class="chip">主訴：未選択</span></div>
  <div class="cards" id="cards"></div>
  <div class="footer-note">※ 体質スコア（0〜100）：高いほどその体質傾向が強いことを示します</div>
</div>

<script>
/* ==== 主訴（カテゴリ横断）収集は既存のまま ==== */
function collectChiefSelections(){
  const checked = Array.from(document.querySelectorAll('input[type="checkbox"][data-cat]:checked'));
  const byCat = new Map();
  checked.forEach(ch=>{
    const cat = ch.getAttribute('data-cat');
    const val = ch.value;
    if(!byCat.has(cat)) byCat.set(cat, []);
    byCat.get(cat).push(val);
  });
  const summary = Array.from(byCat.entries()).map(([cat, list])=>`${cat}：${list.join("・")}`);
  const selections = Array.from(byCat.entries()).map(([category, symptoms])=>({category, symptoms}));
  return {summaryText: summary.join(" ｜ "), selections};
}

/* ====== 証ロジック（MAP：症状→軸スコア） ====== */
const AXES = ["qi_xu","qi_zhi","xue_xu","yu_xue","shui_tai","netsu","kan","kyo","jitsu"];

const MAP = {
  // 感情・眠り
  "emo_irrit":{qi_zhi:1,jitsu:0.5}, "emo_angry":{qi_zhi:1,jitsu:0.5},
  "emo_anx":{xue_xu:1}, "emo_tension":{qi_zhi:1},
  "emo_sigh":{qi_zhi:1}, "sleep_dream":{xue_xu:1},
  "sleep_shallow":{xue_xu:1}, "sleep_daytime":{qi_xu:1,kyo:1},
  "sleep_heat_insomnia":{netsu:1,jitsu:0.5},

  // 体の傾向
  "tend_cold":{kan:1,kyo:1}, "tend_flush":{netsu:1,jitsu:0.5},
  "tend_upperhot_lowercold":{netsu:1,kan:1,qi_zhi:1},
  "tend_edema":{shui_tai:1}, "tend_heavy":{shui_tai:1},
  "tend_sweat_easily":{qi_xu:1}, "tend_fatigue":{qi_xu:1},
  "tend_pale":{xue_xu:1}, "tend_dyspnea":{qi_xu:1},

  // 体の状態
  "stiff_shoulder":{qi_zhi:1,yu_xue:1}, "fixed_pain":{yu_xue:1,jitsu:0.5},
  "numbness":{xue_xu:1}, "cold_extremities":{kan:1},
  "dry_skin":{xue_xu:1}, "spots_dull":{yu_xue:1},
  "acne_red":{netsu:1,jitsu:0.5}, "erythema":{netsu:1},
  "flush_hot":{netsu:1}, "night_sweat":{netsu:1,kyo:0.5},

  // 舌・口・目（舌は1.5倍）
  "t_pale":{xue_xu:1,kyo:0.5}, "t_red":{netsu:1},
  "t_teethmark":{qi_xu:1,shui_tai:1},
  "t_white_thick":{shui_tai:1,kan:1}, "t_yellow_thick":{netsu:1,jitsu:0.5},
  "t_crack_dry":{xue_xu:1,netsu:1},
  "dry_mouth":{netsu:1}, "eye_fatigue":{xue_xu:1}, "eye_red":{netsu:1},

  // 消化・便通・食欲
  "poor_appetite":{qi_xu:1}, "postprandial_sleepy":{qi_xu:1},
  "bloating":{qi_zhi:1}, "loose_stool":{shui_tai:1},
  "diarrhea":{kan:0.5,shui_tai:1}, "constipation":{qi_zhi:1,yu_xue:0.5},
  "alt_diarrhea_constipation":{qi_zhi:1,shui_tai:1},

  // 月経（該当者のみ）
  "m_cycle_short":{netsu:0.5}, "m_cycle_long":{kan:0.5,xue_xu:0.5},
  "m_cycle_irregular":{qi_zhi:0.5,qi_xu:0.5},
  "m_heavy":{netsu:1,jitsu:0.5}, "m_light":{xue_xu:1},
  "m_bright_red":{netsu:0.5}, "m_dark_clots":{yu_xue:1,jitsu:0.5},
  "m_dysmenorrhea_strong":{yu_xue:0.5,qi_zhi:0.5},
  "m_warm_relief":{kan:0.5}, "m_cold_worse":{kan:0.5},
  "pms_breast_swelling":{qi_zhi:0.5}, "pms_irritability":{qi_zhi:0.5}, "pms_edema":{shui_tai:0.5}
};

function gatherSelectedSho(){
  return Array.from(document.querySelectorAll('input[type="checkbox"]:not([data-cat]):checked')).map(i=>i.value);
}

// 舌1.5倍・寒熱/虚実の拮抗・下限0
function accumulate(ids){
  const s = Object.fromEntries(AXES.map(k=>[k,0]));
  ids.forEach(id=>{
    const add = MAP[id]; if(!add) return;
    const isTongue = id.startsWith('t_');
    for(const [k,v] of Object.entries(add)){
      s[k] += isTongue ? 1.5*v : v;
    }
  });
  s.netsu = Math.max(0, s.netsu - 0.5*s.kan);
  s.jitsu = Math.max(0, s.jitsu - 0.5*s.kyo);
  return s;
}

// 正規化：/5 で飽和抑制 → 0〜100（％を付けない）
const norm = x => Math.max(0, Math.min(1, x/5));
const score = x => Math.round(100*x);

// 合成：8軸の体質スコア
function composite(s){
  const QiDef   = score(norm(s.qi_xu));
  const QiStag  = score(norm(s.qi_zhi));
  const BloodDef= score(norm(s.xue_xu));
  const Stasis  = score(norm(s.yu_xue));
  const Damp    = score(norm(s.shui_tai));
  const YinDef  = score(Math.max(0, Math.min(1, 0.6*norm(s.netsu)+0.4*norm(s.kyo)-0.3*norm(s.jitsu))));
  const YangDef = score(Math.max(0, Math.min(1, norm(s.kan)+0.6*norm(s.kyo)-0.3*norm(s.jitsu))));
  const YangHeat= score(Math.max(0, Math.min(1, norm(s.netsu)+norm(s.jitsu)-0.4*norm(s.kyo))));
  return [
    ["気虚体質",QiDef],["血虚体質",BloodDef],["陰虚体質",YinDef],
    ["陽虚体質",YangDef],["気滞体質",QiStag],["瘀血体質",Stasis],
    ["水滞体質",Damp],["陽熱体質",YangHeat]
  ];
}

// 表示
function renderCards(pairs){
  document.getElementById('cards').innerHTML = pairs.map(([name,val])=>`
    <div class="card">
      <div class="muted">${name}</div>
      <div class="big">${val}</div>
      <div class="muted">体質スコア（0〜100）</div>
    </div>
  `).join('');
}

// 計算ボタン
document.getElementById('calc').textContent = '体質スコアを計算して表示';
document.getElementById('calc').onclick = ()=>{
  const ids = gatherSelectedSho();
  const s = accumulate(ids);
  const pairs = composite(s);
  renderCards(pairs);

  const who = `${document.getElementById('name').value||"（氏名未入力）"} / ${document.getElementById('age').value||"年齢未入力"}歳 / ${document.getElementById('gender').value||"性別未選択"}`;
  document.getElementById('who').textContent = `対象者：${who}`;

  const chief = collectChiefSelections();
  const detail = document.getElementById('chief_detail').value.trim();
  document.getElementById('chief_out').textContent = chief.summaryText
    ? `主訴：${chief.summaryText}（${detail||"詳細未記入"}）`
    : `主訴：未選択（${detail||"詳細未記入"}）`;
};

/* ==== AI送信（バックエンドへ POST）==== */
document.getElementById("sendAI").onclick = async (ev)=>{
  const btn = ev.currentTarget;
  try{
    setLoading(true, btn);

    const ids = gatherSelectedSho();
    const s = accumulate(ids);
    const pairs = composite(s);
    const constitution = Object.fromEntries(pairs); // 0-100（点）

    const checked = Array.from(document.querySelectorAll('input[type="checkbox"][data-cat]:checked'));
    const byCat = {};
    checked.forEach(ch=>{
      const cat = ch.getAttribute('data-cat'), val = ch.value;
      if(!byCat[cat]) byCat[cat] = [];
      byCat[cat].push(val);
    });
    const selections = Object.entries(byCat).map(([category, symptoms])=>({category, symptoms}));
    const detail = document.getElementById('chief_detail').value.trim();

    const payload = {
      name: document.getElementById('name').value,
      age: document.getElementById('age').value,
      gender: document.getElementById('gender').value,
      chief: { selections, detail },
      constitution
    };

    const controller = new AbortController();
    const t = setTimeout(()=>controller.abort(), 60000);
    const res = await fetch("/analyze", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify(payload),
      signal: controller.signal
    }).catch(e=>{ throw new Error(e.name==='AbortError'?'タイムアウトしました':e.message); });
    clearTimeout(t);

    if(!res.ok) throw new Error(`サーバエラー (${res.status}) ${await res.text()}`);

    const result = await res.json();
    document.getElementById("aiResult").innerHTML = `
      <h3>AIによる提案結果</h3>
      <p><b>症状優先：</b> ${result.formula_symptom?.name || "-"}<br>
      <span class="muted">${result.formula_symptom?.reason || "-"}</span></p>
      <p><b>証優先：</b> ${result.formula_sho?.name || "-"}<br>
      <span class="muted">${result.formula_sho?.reason || "-"}</span></p>
      <p><b>折衷案：</b> ${result.formula_mixed?.name || "-"}<br>
      <span class="muted">${result.formula_mixed?.reason || "-"}</span></p>
      <hr>
      <h4>指導内容</h4>
      <p><b>療養の要点：</b><br>${result.guidance?.["療養の要点"] || "-"}</p>
      <p><b>おすすめ薬膳食材：</b></p>
      <ul>
        ${(result.guidance?.["おすすめ薬膳食材"] || [])
          .map(item => `<li>${item.name} — ${item.reason}</li>`)
          .join("")}
      </ul>
    `;
  }catch(err){
    document.getElementById("aiResult").innerHTML =
      `<div style="color:#b91c1c"><b>送信に失敗：</b>${String(err)}</div>`;
  }finally{
    setLoading(false, btn);
  }
};

/* ==== Thinking Overlay ==== */
function setLoading(isLoading, btn){
  const overlay = document.getElementById('thinkingOverlay');
  const calcBtn = document.getElementById('calc');
  const sendBtn = document.getElementById('sendAI');
  if(isLoading){
    overlay.style.display = 'flex';
    calcBtn?.setAttribute('disabled','true');
    sendBtn?.setAttribute('disabled','true');
    if(btn){
      btn.dataset._orig = btn.textContent;
      btn.textContent = '送信中...';
    }
  }else{
    overlay.style.display = 'none';
    calcBtn?.removeAttribute('disabled');
    sendBtn?.removeAttribute('disabled');
    if(btn && btn.dataset._orig){
      btn.textContent = btn.dataset._orig;
      delete btn.dataset._orig;
    }
  }
}
</script>

<!-- Thinking overlay -->
<div id="thinkingOverlay" role="status" aria-live="polite" aria-busy="true">
  <div style="display:flex;flex-direction:column;align-items:center">
    <div class="spinner"></div>
    <div id="thinkingText">AIが処理中です…</div>
  </div>
</div>

</body>
</html>
